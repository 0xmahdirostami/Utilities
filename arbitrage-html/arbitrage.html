<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arbitrage Executor</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <h1>Arbitrage Executor</h1>
    
    <div>
        <label for="apiKey">API Key (Infura):</label>
        <input type="text" id="apiKey" required>
    </div>
    <div>
        <label for="privateKey">Private Key:</label>
        <input type="text" id="privateKey" required>
    </div>
    <div>
        <label for="refreshTimer">Auto-refresh Timer (seconds):</label>
        <input type="number" id="refreshTimer" required>
    </div>
    <button id="saveButton">Save</button>

    <h2>Executable Orders</h2>
    <div id="orders"></div>

    <script>
        let web3;
        let apiKey, privateKey, refreshTimer;
        const recipientAddress = 'YOUR_RECIPIENT_ADDRESS';
        let contractAddress = '0x4f0fe6a8287f3beba2754220fc1aaf2a07a56c7c';
        let contractABI = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "target",
                "type": "address"
            }
        ],
        "name": "AddressEmptyCode",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "AddressInsufficientBalance",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "CannotDecreaseFee",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "FailedInnerCall",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "InsufficientReward",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "InvalidAddress",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "InvalidAmount",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "NotDepositor",
        "type": "error"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "token",
                "type": "address"
            }
        ],
        "name": "SafeERC20FailedOperation",
        "type": "error"
    },
    {
        "inputs": [],
        "name": "TimeNotPassed",
        "type": "error"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "orderID",
                "type": "uint256"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "tokenReceived",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "ArbitrageExecuted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "depositor",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "orderID",
                "type": "uint256"
            }
        ],
        "name": "OrderCreated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "orderID",
                "type": "uint256"
            },
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "depositor",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "tokenRequested",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "minReceivedPer100kPSM",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "psmDeposit",
                        "type": "uint256"
                    }
                ],
                "indexed": false,
                "internalType": "struct Converter.Order",
                "name": "details",
                "type": "tuple"
            }
        ],
        "name": "OrderUpdated",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "ORDER_CREATION_FEE_PSM",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "PSM",
        "outputs": [
            {
                "internalType": "contract IERC20",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "PSM_AMOUNT_FOR_CONVERT",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_orderID",
                "type": "uint256"
            }
        ],
        "name": "checkArbitrage",
        "outputs": [
            {
                "internalType": "bool",
                "name": "canExecute",
                "type": "bool"
            },
            {
                "internalType": "address",
                "name": "portal",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "amountReceived",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_tokenRequested",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_minReceivedPer100kPSM",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "createOrder",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_orderID",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "decreaseOrder",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "enabledTokens",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_recipient",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_orderID",
                "type": "uint256"
            }
        ],
        "name": "executeArbitrage",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "executionRewardPercent",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "feeUpdateTime",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_orderID",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "increaseOrder",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "orderIndex",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "orderID",
                "type": "uint256"
            }
        ],
        "name": "orders",
        "outputs": [
            {
                "internalType": "address",
                "name": "depositor",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "tokenRequested",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "minReceivedPer100kPSM",
                "type": "uint256"
            },
            {
                "internalType": "uint256",
                "name": "psmDeposit",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "setApprovals",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "updateExecutionFee",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
]

        document.getElementById('saveButton').addEventListener('click', saveSettings);

        function saveSettings() {
            apiKey = document.getElementById('apiKey').value;
            privateKey = document.getElementById('privateKey').value;
            refreshTimer = document.getElementById('refreshTimer').value * 1000;

            console.log('API Key:', apiKey);
            console.log('Private Key:', privateKey);
            console.log('Refresh Timer:', refreshTimer);

            web3 = new Web3(new Web3.providers.HttpProvider(`https://arbitrum-mainnet.infura.io/v3/${apiKey}`));

            fetchExecutableOrders();
            setInterval(fetchExecutableOrders, refreshTimer);
        }

        async function fetchExecutableOrders() {
            const contract = new web3.eth.Contract(contractABI, contractAddress);

            try {
                const orderCount = await contract.methods.orderIndex().call();
                const ordersDiv = document.getElementById('orders');
                ordersDiv.innerHTML = '';

                for (let i = 0; i < orderCount; i++) {
                    const result = await contract.methods.checkArbitrage(i).call();
                    console.log(`Order ${i} - Result:`, result); // Debugging info

                    // if (result.canExecute) {
                        const orderDiv = document.createElement('div');
                        orderDiv.innerHTML = `
                            <p>Order ID: ${i}</p>
                            <p>Can Execute: ${result.canExecute}</p>
                            <p>Portal: ${result.portal}</p>
                            <p>Amount Received: ${result.amountReceived}</p>
                            <button onclick="executeOrder(${i})">Execute</button>
                        `;
                        ordersDiv.appendChild(orderDiv);
                        console.log(`Order ${i} appended to ordersDiv`); // Debugging info
                    // }
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        async function executeOrder(orderId) {
            const contract = new web3.eth.Contract(contractABI, contractAddress);
            const data = contract.methods.executeArbitrage(recipientAddress, orderId).encodeABI();

            const transaction = {
                to: contractAddress,
                data: data,
                gas: 2000000
            };

            try {
                const signedTransaction = await web3.eth.accounts.signTransaction(transaction, privateKey);
                await web3.eth.sendSignedTransaction(signedTransaction.rawTransaction)
                    .on('receipt', receipt => {
                        console.log('Transaction receipt:', receipt);
                        fetchExecutableOrders();
                    });
            } catch (error) {
                console.error('Error executing order:', error);
            }
        }
    </script>
</body>
</html>
